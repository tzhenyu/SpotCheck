<!DOCTYPE html>
<html>
<head>
    <title>Test Username Extraction Debug</title>
</head>
<body>
    <h1>Username Extraction Debug</h1>
    <div id="results"></div>
    
    <script>
        // This script should be run on an actual Shopee page
        if (window.location.hostname.includes('shopee')) {
            console.log('Running username extraction debug on Shopee page');
            
            // Test the username extraction directly
            const COMMENT_SELECTORS = {
                CENSORED_USERNAME: 'div.InK5kS',
                UNCENSORED_USERNAME: 'a.InK5kS',
                TIMESTAMP: 'div.XYk98l',
                COMMENT: 'div.YNedDV',
                COMMENT_CONTAINER: '.shopee-product-comment-list',
                STAR_RATING: 'div.rGdC5O',
            };
            
            function findCommentContainer(element) {
                let container = element.parentElement;
                for (let i = 0; i < 5; i++) {
                    if (!container) return null;
                    
                    const hasUsername = container.querySelector(COMMENT_SELECTORS.CENSORED_USERNAME) || 
                                       container.querySelector(COMMENT_SELECTORS.UNCENSORED_USERNAME);
                    const hasTimestamp = container.querySelector(COMMENT_SELECTORS.TIMESTAMP);
                    
                    if (hasUsername && hasTimestamp) return container;
                    
                    container = container.parentElement;
                }
                return null;
            }
            
            function extractUsername(container) {
                const censoredUser = container.querySelector(COMMENT_SELECTORS.CENSORED_USERNAME);
                const uncensoredUser = container.querySelector(COMMENT_SELECTORS.UNCENSORED_USERNAME);
                
                console.log('Username extraction debug:', {
                    censoredUser: censoredUser ? censoredUser.textContent : null,
                    uncensoredUser: uncensoredUser ? uncensoredUser.textContent : null
                });
                
                if (uncensoredUser) return uncensoredUser.textContent.trim();
                if (censoredUser) return censoredUser.textContent.trim();
                
                return 'Unknown user';
            }
            
            // Extract all comments and debug the username extraction
            setTimeout(() => {
                const commentElements = document.querySelectorAll(COMMENT_SELECTORS.COMMENT);
                console.log(`Found ${commentElements.length} comment elements`);
                
                let results = [];
                
                commentElements.forEach((commentElement, index) => {
                    console.log(`Processing comment ${index + 1}:`);
                    
                    const commentContainer = findCommentContainer(commentElement);
                    if (commentContainer) {
                        const commentText = commentElement.textContent.trim();
                        const username = extractUsername(commentContainer);
                        
                        console.log(`Comment ${index + 1}:`, {
                            text: commentText.substring(0, 50) + '...',
                            username: username,
                            containerFound: true
                        });
                        
                        results.push({
                            index: index + 1,
                            text: commentText.substring(0, 50) + '...',
                            username: username,
                            containerFound: true
                        });
                    } else {
                        console.log(`Comment ${index + 1}: No container found`);
                        results.push({
                            index: index + 1,
                            text: commentElement.textContent.trim().substring(0, 50) + '...',
                            username: 'No container found',
                            containerFound: false
                        });
                    }
                });
                
                // Display results in the page
                const resultsDiv = document.getElementById('results');
                if (resultsDiv) {
                    let html = '<h3>Username Extraction Results:</h3>';
                    results.forEach(result => {
                        html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                            <strong>Comment ${result.index}:</strong><br>
                            Text: ${result.text}<br>
                            Username: <span style="color: ${result.username === 'Unknown user' || result.username === 'No container found' ? 'red' : 'green'}">${result.username}</span><br>
                            Container Found: ${result.containerFound}
                        </div>`;
                    });
                    resultsDiv.innerHTML = html;
                }
                
                console.log('Username extraction debug completed. Results:', results);
            }, 2000);
        } else {
            document.getElementById('results').innerHTML = '<p style="color: red;">This script must be run on a Shopee page to test username extraction.</p>';
        }
    </script>
</body>
</html>
